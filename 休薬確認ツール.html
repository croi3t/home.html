<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¡“å‰ä¼‘è–¬ç¢ºèªãƒ„ãƒ¼ãƒ« Ver17.0 (Menu)</title>
    <style>
        /* --- åŸºæœ¬è¨­å®š (Bootstrapéä¾å­˜ãƒ»ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å®Œå…¨å¯¾å¿œ) --- */
        body { font-family: "Helvetica Neue", Arial, sans-serif; background-color: #f4f6f9; color: #333; margin: 0; padding: 20px; }
        * { box-sizing: border-box; }

        /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ»ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ */
        .d-none { display: none !important; }
        .d-flex { display: flex; }
        .align-items-center { align-items: center; }
        .justify-content-between { justify-content: space-between; }
        .gap-2 { gap: 0.5rem; }
        .w-100 { width: 100%; }
        .w-50 { width: 50%; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-3 { margin-bottom: 1rem; }
        .mt-1 { margin-top: 0.25rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-3 { margin-top: 1rem; }
        .fw-bold { font-weight: bold; }
        .small { font-size: 0.875rem; }
        .text-center { text-align: center; }
        .text-end { text-align: right; }
        .text-muted { color: #6c757d; }
        .text-primary { color: #0d6efd; }
        .text-danger { color: #dc3545; }
        .pt-2 { padding-top: 0.5rem; }
        .py-4 { padding-top: 1.5rem; padding-bottom: 1.5rem; }
        .border-top { border-top: 1px solid #dee2e6; }
        .border-bottom { border-bottom: 1px solid #dee2e6; }

        /* ã‚³ãƒ³ãƒ†ãƒŠ */
        .container-main { max-width: 1300px; margin: 0 auto; background: white; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-radius: 4px; position: relative; }

        /* ãƒœã‚¿ãƒ³ */
        .btn { display: inline-block; font-weight: 400; text-align: center; vertical-align: middle; cursor: pointer; border: 1px solid transparent; padding: 0.375rem 0.75rem; font-size: 1rem; border-radius: 0.25rem; transition: all 0.15s; }
        .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.875rem; }
        .btn-primary { color: #fff; background-color: #0d6efd; border-color: #0d6efd; }
        .btn-primary:hover { background-color: #0b5ed7; }
        .btn-secondary { color: #fff; background-color: #6c757d; border-color: #6c757d; }
        .btn-secondary:hover { background-color: #5c636a; }
        .btn-success { color: #fff; background-color: #198754; border-color: #198754; }
        .btn-success:hover { background-color: #157347; }
        .btn-outline-secondary { color: #6c757d; border-color: #6c757d; background: white; }
        .btn-outline-secondary:hover { color: #fff; background-color: #6c757d; }

        /* ãƒ•ã‚©ãƒ¼ãƒ  & ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³æ‹¡å¤§ */
        .form-control { display: block; width: 100%; padding: 0.375rem 0.75rem; font-size: 1rem; border: 1px solid #ced4da; border-radius: 0.25rem; }
        textarea.form-control { resize: vertical; }
        input[type="date"] { position: relative; padding-right: 5px; cursor: pointer; }
        input[type="date"]::-webkit-calendar-picker-indicator {
            width: 24px; height: 24px; cursor: pointer;
            filter: invert(34%) sepia(9%) saturate(1908%) hue-rotate(182deg) brightness(93%) contrast(88%);
        }

        /* ã‚¢ãƒ©ãƒ¼ãƒˆ */
        .alert { position: relative; padding: 1rem 1rem; margin-bottom: 1rem; border: 1px solid transparent; border-radius: 0.25rem; }
        .alert-warning { color: #664d03; background-color: #fff3cd; border-color: #ffecb5; }
        
        /* ã‚°ãƒªãƒƒãƒ‰ */
        .row { display: flex; flex-wrap: wrap; margin-right: -0.75rem; margin-left: -0.75rem; }
        .col-auto { flex: 0 0 auto; width: auto; padding: 0 0.75rem; }
        .col-md-3 { flex: 0 0 auto; width: 25%; padding: 0 0.75rem; }
        .col-md-4 { flex: 0 0 auto; width: 33.3333%; padding: 0 0.75rem; }
        .col-md-5 { flex: 0 0 auto; width: 41.6667%; padding: 0 0.75rem; }
        .col-md-6 { flex: 0 0 auto; width: 50%; padding: 0 0.75rem; }

        /* ã‚¿ãƒ– */
        .sticky-tabs { position: -webkit-sticky; position: sticky; top: 0; z-index: 900; background-color: #f4f6f9; padding-top: 10px; margin-bottom: 20px; border-bottom: 1px solid #dee2e6; }
        .nav-tabs { display: flex; list-style: none; padding-left: 0; margin-bottom: 0; border-bottom: 1px solid #dee2e6; }
        .nav-item { margin-bottom: -1px; }
        .nav-link { display: block; padding: 0.5rem 1rem; text-decoration: none; background-color: #e9ecef; border: 1px solid #dee2e6; margin-right: 4px; color: #555; font-weight: 500; border-top-left-radius: 0.25rem; border-top-right-radius: 0.25rem; cursor: pointer; }
        .nav-link:hover { background-color: #dde0e3; }
        .nav-link.active { color: #0d6efd; background-color: #fff; border-color: #dee2e6 #dee2e6 #fff; font-weight: bold; }
        .tab-pane { display: none; }
        .tab-pane.show { display: block; }

        /* ãƒ†ãƒ¼ãƒ–ãƒ« */
        .table { width: 100%; margin-bottom: 1rem; vertical-align: top; border-color: #dee2e6; border-collapse: collapse; }
        .table-bordered th, .table-bordered td { border: 1px solid #dee2e6; }
        .table-custom { font-size: 15px; }
        .table-custom th { background-color: #2c3e50 !important; color: #ffffff !important; text-align: center; font-weight: 600; padding: 8px; white-space: nowrap; }
        .table-custom td { padding: 6px 8px; line-height: 1.3; vertical-align: middle; }
        .table-fixed { table-layout: fixed; }
        .cell-nowrap { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .cell-wrap { word-wrap: break-word; overflow-wrap: break-word; }

        tr.row-none td { background-color: #ffffff; color: #333; }
        tr.row-alert td { background-color: #ffe6e6; color: #b00; font-weight: bold; }
        tr.row-gray td { background-color: #f2f2f2; color: #666; }

        /* å‚è€ƒæ–‡çŒ®ãƒªã‚¹ãƒˆ */
        .citation-list { padding-left: 0; list-style: none; margin-bottom: 0; }
        .citation-item { padding-left: 1.5em; text-indent: -1.5em; margin-bottom: 2px; font-size: 0.85rem; }

        /* ãƒˆãƒƒãƒ—ã¸æˆ»ã‚‹ãƒœã‚¿ãƒ³ */
        #backToTop { display: none; position: fixed; bottom: 30px; right: 30px; z-index: 2000; font-size: 18px; border: none; background-color: #0d6efd; color: white; cursor: pointer; padding: 10px 15px; border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.3); opacity: 0.8; transition: opacity 0.3s; }
        #backToTop:hover { opacity: 1; background-color: #0b5ed7; }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-dialog { margin: 1.75rem auto; max-width: 90%; width: 210mm; }
        .modal-content { position: relative; display: flex; flex-direction: column; width: 100%; background-color: #fff; border-radius: 0.3rem; }
        .modal-header { display: flex; align-items: center; justify-content: space-between; padding: 1rem; border-bottom: 1px solid #dee2e6; }
        .modal-body { position: relative; flex: 1 1 auto; padding: 1rem; background-color: #6c757d; }
        .modal-footer { display: flex; flex-wrap: wrap; align-items: center; justify-content: flex-end; padding: 0.75rem; border-top: 1px solid #dee2e6; }
        .btn-close { padding: 0.5rem; background: transparent; border: 0; font-size: 1.5rem; font-weight: 700; cursor: pointer; }

        /* ==========================================================================
           ã€ã‚¿ãƒ–4ã€‘æŠ—å‡å›ºãƒ»æŠ—è¡€å°æ¿è–¬ãƒ—ãƒ­ãƒˆã‚³ãƒ« å°‚ç”¨ã‚¹ã‚¿ã‚¤ãƒ«
           ========================================================================== */
        #ac-wrapper { font-family: "Helvetica Neue", Arial, sans-serif; color: #333; }
        #ac-wrapper h1 { text-align: center; color: #2c3e50; border-bottom: 3px solid #34495e; padding-bottom: 15px; margin-bottom: 30px; font-size: 24px; }
        #ac-wrapper .date-section { background-color: #e3f2fd; border: 1px solid #bbdefb; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; }
        
        #ac-wrapper .selection-area { display: flex; gap: 30px; margin-bottom: 30px; }
        #ac-wrapper .step-box { flex: 1; background: #f9f9f9; padding: 20px; border-radius: 8px; border: 1px solid #ddd; }
        #ac-wrapper h2 { font-size: 1.1rem; color: #2980b9; margin-top: 0; border-left: 5px solid #2980b9; padding-left: 10px; }
        #ac-wrapper button.custom-btn { padding: 12px; font-size: 0.95rem; text-align: left; background-color: #fff; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; width: 100%; margin-bottom: 8px; color: #333; }
        #ac-wrapper button.custom-btn:hover { background-color: #eaf2f8; border-color: #3498db; }
        #ac-wrapper button.custom-btn.selected { background-color: #3498db; color: white; border-color: #2980b9; font-weight: bold; }
        
        #ac-result-area { display: none; border-top: 2px dashed #bdc3c7; padding-top: 30px; margin-bottom: 50px; }
        #ac-wrapper .comparison-container { display: flex; gap: 20px; }
        #ac-wrapper .risk-col { flex: 1; padding: 20px; border-radius: 6px; border: 2px solid transparent; display: flex; flex-direction: column; }
        #ac-wrapper .risk-high { background-color: #fff5f5; border-color: #e74c3c; }
        #ac-wrapper .risk-low { background-color: #f0f9ff; border-color: #3498db; }
        #ac-wrapper .risk-title { font-weight: bold; font-size: 1.2rem; margin-bottom: 10px; text-align: center; padding: 5px; border-radius: 4px; color: white; }
        #ac-wrapper .risk-high .risk-title { background-color: #c0392b; }
        #ac-wrapper .risk-low .risk-title { background-color: #2980b9; }
        
        #ac-wrapper .definition-box { font-size: 0.85rem; background: #fff; padding: 10px; border: 1px solid #ddd; margin-bottom: 15px; color: #555; }
        #ac-wrapper .action-box { font-size: 1.1rem; font-weight: bold; padding: 15px; background: #fff; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); flex-grow: 1; }
        #ac-wrapper .schedule-info { margin-top: 15px; padding-top: 15px; border-top: 1px dotted #ccc; font-size: 1.2rem; color: #c0392b; font-weight: bold; text-align: center; }
        
        #ac-wrapper .footer-info { margin-top: 20px; padding: 15px; background-color: #fff8e1; border: 1px solid #ffe082; border-radius: 5px; }
        #ac-wrapper .footer-title { font-weight: bold; color: #f57c00; margin-bottom: 5px; }
        
        #ac-wrapper details { margin-top: 40px; border: 1px solid #ccc; background: #fff; }
        #ac-wrapper summary { background: #eee; padding: 15px; cursor: pointer; font-weight: bold; font-size: 1.1rem; }
        #ac-wrapper .table-container { overflow-x: auto; padding: 10px; }
        #ac-wrapper table.ref-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; line-height: 1.5; }
        #ac-wrapper table.ref-table th, #ac-wrapper table.ref-table td { border: 1px solid #888; padding: 6px 5px; vertical-align: top; }
        #ac-wrapper .col-drug { width: 10%; }
        #ac-wrapper .col-risk { width: 26%; }
        #ac-wrapper .col-surg-sm { width: 10%; }
        #ac-wrapper .col-surg-lg { width: 22%; }
        #ac-wrapper .bg-header { background-color: #343a40; color: #fff; text-align: center; }
        #ac-wrapper .bg-warfarin { background-color: #fff3cd; }
        #ac-wrapper .bg-doac { background-color: #d1e7dd; }
        #ac-wrapper .bg-platelet { background-color: #fff9c4; }
        #ac-wrapper .txt-center { text-align: center; }
        #ac-wrapper .txt-bold { font-weight: bold; }
        #ac-wrapper .no-wrap { white-space: nowrap; }
        
        /* ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºæ‹¡å¤§ & ã¶ã‚‰ä¸‹ã’ */
        #ac-wrapper .risk-list { font-size: 100%; color: #333; margin-top: 5px; text-align: left; line-height: 1.4; }
        #ac-wrapper .hanging-item { padding-left: 1em; text-indent: -1em; margin-bottom: 4px; }
        
        #ac-wrapper .heparin-note { margin-top: 8px; padding-top:5px; border-top:1px dashed #999; color: #c0392b; font-size:0.8rem;}
        #ac-wrapper .drug-list { font-size: 0.85rem; font-weight: normal; margin-top: 5px; display: block; }
        #ac-wrapper .drug-item { display: block; }
        #ac-wrapper .bottom-notes { margin-top: 20px; padding: 15px; border-top: 2px solid #333; font-size: 0.85rem; }
        #ac-wrapper .note-block { margin-bottom: 10px; }
        #ac-wrapper .note-title { font-weight: bold; text-decoration: underline; margin-bottom: 3px;}

        /* --- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒãƒ¼CSS --- */
        #menu-toggle-btn { position: fixed; top: 15px; right: 20px; z-index: 9999; width: 50px; height: 50px; background-color: #333; border: 2px solid #fff; border-radius: 8px; cursor: pointer; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 6px; box-shadow: 0 4px 8px rgba(0,0,0,0.3); transition: all 0.3s; }
        #menu-toggle-btn:hover { background-color: #555; transform: scale(1.05); }
        .bar { width: 28px; height: 3px; background-color: white; border-radius: 2px; }
        #menu-content { display: none; position: fixed; top: 75px; right: 20px; width: 260px; background-color: #333; border: 1px solid #555; border-radius: 8px; padding: 15px; z-index: 9998; box-shadow: 0 10px 25px rgba(0,0,0,0.5); flex-direction: column; font-family: "Helvetica Neue", Arial, sans-serif; text-align: left; }
        #menu-content.active { display: flex; animation: fadeIn 0.2s ease-out; }
        .menu-link { display: block; color: white !important; text-decoration: none; padding: 12px 15px; margin-bottom: 6px; border-radius: 4px; background-color: #444; font-size: 16px; font-weight: bold; transition: background 0.2s; }
        .menu-link:hover { background-color: #0d6efd; color: white; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* å°åˆ·è¨­å®š (å…±é€š) */
        @media print {
            .no-print, .nav-tabs, .btn, .form-control, .alert, .modal, #backToTop, .sticky-tabs, #custom-hamburger-menu { display: none !important; }
            .container-main { box-shadow: none; margin: 0; padding: 0; max-width: 100% !important; width: 100% !important; }
            .print-header { display: flex !important; justify-content: space-between; align-items: flex-end; margin-bottom: 10px; border-bottom: 2px solid #000; padding-bottom: 5px; }
            .tab-pane { display: none !important; }
            .tab-pane.show { display: block !important; }
            /* èƒŒæ™¯è‰²å¼·åˆ¶ */
            tr.row-alert td { background-color: #ffe6e6 !important; }
            tr.row-gray td { background-color: #f2f2f2 !important; }
            #ac-wrapper .risk-high { background-color: #fff5f5 !important; }
            #ac-wrapper .risk-low { background-color: #f0f9ff !important; }
            /* æŠ—å‡å›ºã‚¿ãƒ–å°åˆ· */
            #ac-wrapper .selection-area, #ac-wrapper .date-section { display: none; }
            #ac-wrapper details { display: block !important; }
            #ac-wrapper summary { display: none; }
            #printCitationList { column-count: 2; column-gap: 20px; font-size: 9pt; margin-top: 10px; }
            @page { margin: 10mm; size: auto; }
        }
        .print-header { display: none; }
    </style>
</head>
<body>

<div id="custom-hamburger-menu" class="no-print">
    <button id="menu-toggle-btn" onclick="toggleMenu()" title="ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹ã">
        <span class="bar"></span><span class="bar"></span><span class="bar"></span>
    </button>
    <nav id="menu-content">
        <div style="color:#aaa; font-size:12px; margin-bottom:10px; text-align:center; border-bottom:1px solid #555; padding-bottom:5px;">æ¥­å‹™æ”¯æ´ãƒ„ãƒ¼ãƒ«çµ±åˆãƒ¡ãƒ‹ãƒ¥ãƒ¼</div>
        <a href="index.html" class="menu-link">ğŸ  ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ã¸</a>
        <hr style="margin: 8px 0; border-color: #555;">
        <a href="ä¼‘è–¬ç¢ºèªãƒ„ãƒ¼ãƒ«.html" class="menu-link">ğŸ’Š ä¼‘è–¬ç¢ºèªãƒ„ãƒ¼ãƒ«</a>
        <a href="é…åˆå¤‰åŒ–ãƒ„ãƒ¼ãƒ«.html" class="menu-link">ğŸ’‰ é…åˆå¤‰åŒ–ãƒ„ãƒ¼ãƒ«</a>
        <a href="å°å…æŠ•ä¸é‡ç¢ºèªãƒ„ãƒ¼ãƒ«.html" class="menu-link">ğŸ‘¶ å°å…ç”¨é‡ç›£æŸ»</a>
        <button onclick="toggleMenu()" style="width:100%; margin-top:10px; background:transparent; border:1px solid #777; color:#ccc; padding:5px; border-radius:4px; cursor:pointer;">é–‰ã˜ã‚‹</button>
    </nav>
</div>

<button id="backToTop" onclick="window.scrollTo({top: 0, behavior: 'smooth'});">â–²</button>

<div class="container-main">
    <div class="d-flex justify-content-between align-items-center no-print mb-3">
        <h3 class="fw-bold m-0">ğŸ¥ è¡“å‰ä¼‘è–¬ç¢ºèªãƒ„ãƒ¼ãƒ« Ver17.0</h3>
        <button class="btn btn-secondary btn-sm" onclick="window.location.reload()">ãƒªã‚»ãƒƒãƒˆ</button>
    </div>

    <div class="alert alert-warning border border-warning small no-print">
        <strong>ã€ã”æ³¨æ„ã€‘</strong> æœ¬è¡¨ã¯æ±ç”¨è–¬ã‚’æŠœç²‹ã—ãŸã‚‚ã®ã§ã™ã€‚ã“ã‚Œä»¥å¤–ã«ã‚‚ç•™æ„ã™ã¹ãè–¬å‰¤ãŒã‚ã‚Šã¾ã™ã€‚ã‚ãã¾ã§ã‚‚ä¸€ç›®å®‰ã¨ã—ã¦ã”åˆ©ç”¨ãã ã•ã„ã€‚
    </div>

    <div class="sticky-tabs no-print">
        <ul class="nav nav-tabs">
            <li class="nav-item"><a class="nav-link active" onclick="switchTab('check-tab')">â‘  åˆ¤å®šãƒ»ãƒªã‚¹ãƒˆä½œæˆ</a></li>
            <li class="nav-item"><a class="nav-link" onclick="switchTab('schedule-tab')">â‘¡ ä¼‘è–¬æ—¥ç¢ºèª</a></li>
            <li class="nav-item"><a class="nav-link" id="master-tab-btn" onclick="switchTab('master-tab')">â‘¢ è–¬å‰¤ä¸€è¦§æ¤œç´¢</a></li>
            <li class="nav-item"><a class="nav-link" onclick="switchTab('anticoagulant-tab')">â‘£ æŠ—å‡å›ºãƒ»æŠ—è¡€å°æ¿è–¬ãƒ—ãƒ­ãƒˆã‚³ãƒ«</a></li>
        </ul>
    </div>

    <div class="tab-content">
        <div id="check-tab" class="tab-pane show active">
            <div class="row g-2 mb-3 no-print">
                <div class="col-md-5">
                    <textarea id="rawInput" class="form-control" rows="4" placeholder="é›»å­ã‚«ãƒ«ãƒ†ç­‰ã®è–¬å‰¤ãƒªã‚¹ãƒˆã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„"></textarea>
                </div>
                <div class="col-md-4">
                    <label class="small fw-bold">æ‰‹è¡“äºˆå®šæ—¥</label>
                    <input type="date" id="surgeryDate" class="form-control" onchange="processData()">
                    <div class="text-primary small mt-1">â€»æ‰‹è¡“æ—¥æœªå…¥åŠ›ã§ã‚‚åˆ¤å®šå¯èƒ½ã€‚å…¥åŠ›ã§æœŸé–“ã‚’è¡¨ç¤ºã€‚</div>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-primary w-100 mb-2 fw-bold" onclick="processData()">åˆ¤å®šå®Ÿè¡Œ</button>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-secondary w-50" onclick="showPreview()">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
                        <button class="btn btn-success w-50" onclick="window.print()">å°åˆ·</button>
                    </div>
                </div>
            </div>

            <div class="print-header">
                <div style="font-size: 16pt; font-weight: bold;">è–¬å‰¤ä¼‘è–¬ç¢ºèªãƒªã‚¹ãƒˆ</div>
                <div id="printDateDisplay" style="font-size: 12pt; font-weight: bold;">æ‰‹è¡“äºˆå®šæ—¥ï¼šæœªè¨­å®š</div>
            </div>
            <div class="d-none d-print-block small border-bottom mb-2 pb-1">
                â€»æœ¬è¡¨ã¯æ±ç”¨è–¬ã‚’æŠœç²‹ã—ãŸã‚‚ã®ã§ã™ã€‚ã“ã‚Œä»¥å¤–ã«ã‚‚ç•™æ„ã™ã¹ãè–¬å‰¤ãŒã‚ã‚Šã¾ã™ã€‚ã‚ãã¾ã§ã‚‚ä¸€ç›®å®‰ã¨ã—ã¦ã”åˆ©ç”¨ãã ã•ã„ã€‚
            </div>

            <table class="table table-bordered table-custom" id="resultTable">
                <thead>
                    <tr>
                        <th style="width: 20%;">è–¬å‰¤å(åˆ¤å®š)</th>
                        <th style="width: 12%;">åˆ†é¡</th>
                        <th style="width: 13%;">ä¼‘è–¬æœŸé–“</th>
                        <th class="col-calc" style="width: 25%;">æ¨å¥¨ä¼‘è–¬æœŸé–“ãƒ»é–‹å§‹æ—¥</th>
                        <th style="width: 25%;">ä¼‘è–¬ç†ç”±</th>
                        <th style="width: 5%;">å¼•ç”¨</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="6" class="text-center text-muted py-4">ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã—ã¦ã€Œåˆ¤å®šå®Ÿè¡Œã€ã‚’æŠ¼ã—ã¦ãã ã•ã„</td></tr>
                </tbody>
            </table>

            <div class="mt-2 border-top pt-2 no-print">
                <small class="text-muted fw-bold">å¼•ç”¨å…ƒ:</small>
                <div id="citationList" class="citation-list small text-muted"></div>
            </div>
            <div class="mt-2 border-top pt-2 d-none d-print-block">
                <small class="fw-bold">ã€å¼•ç”¨ãƒ»æ ¹æ‹ ã€‘</small>
                <div id="printCitationList" class="citation-list"></div>
            </div>
        </div>

        <div id="schedule-tab" class="tab-pane">
            <div class="print-header">
                <div style="font-size: 16pt; font-weight: bold;">ä¼‘è–¬æ—¥ç¢ºèªã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</div>
                <div id="printScheduleDateDisplay" style="font-size: 12pt; font-weight: bold;">æ‰‹è¡“äºˆå®šæ—¥ï¼šæœªè¨­å®š</div>
            </div>
            <div class="row align-items-center mb-3 no-print">
                <div class="col-auto"><label class="fw-bold">æ‰‹è¡“äºˆå®šæ—¥ï¼š</label></div>
                <div class="col-auto"><input type="date" id="scheduleDateInput" class="form-control" onchange="calcScheduleTab()"></div>
                <div class="col-auto"><button class="btn btn-success" onclick="window.print()">ã“ã®ãƒšãƒ¼ã‚¸ã‚’å°åˆ·</button></div>
            </div>
            <div id="scheduleResultArea" class="table-custom"></div>
        </div>

        <div id="master-tab" class="tab-pane">
            <div class="mb-2">
                <input type="text" id="masterSearch" class="form-control" placeholder="è–¬å‰¤åã‚’å…¥åŠ›ï¼ˆã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Šã§è¤‡æ•°æ¤œç´¢å¯èƒ½ï¼‰" onkeyup="filterMasterTable()">
            </div>
            <div style="height: 650px; overflow-y: auto;">
                <table class="table table-custom table-fixed">
                    <thead style="position: sticky; top: 0; z-index: 10;">
                        <tr>
                            <th style="width: 12%;">åˆ†é¡</th>
                            <th style="width: 18%;">å•†å“å</th>
                            <th style="width: 12%;">ä¸€èˆ¬å</th>
                            <th style="width: 18%;">ä¼‘è–¬æœŸé–“</th>
                            <th style="width: 40%;">ç†ç”±</th>
                        </tr>
                    </thead>
                    <tbody id="masterTableBody"></tbody>
                </table>
            </div>
        </div>

        <div id="anticoagulant-tab" class="tab-pane">
            <div id="ac-wrapper">
                <h1>æ‰‹è¡“æ™‚ æŠ—å‡å›ºãƒ»æŠ—è¡€å°æ¿è–¬ ä¼‘è–¬ãƒ»ç½®æ›ãƒ—ãƒ­ãƒˆã‚³ãƒ«</h1>
                <div class="date-section no-print">
                    <label class="date-label">ğŸ“… æ‰‹è¡“äºˆå®šæ—¥ï¼š</label>
                    <input type="date" id="ac-surgery-date" onchange="updateACDisplay()">
                    <span style="font-size:0.9rem; margin-left:10px; color:#666;">ï¼ˆå…¥åŠ›ã™ã‚‹ã¨ä¼‘è–¬é–‹å§‹æ—¥ã‚’è‡ªå‹•è¨ˆç®—ã—ã¾ã™ï¼‰</span>
                </div>
                <div class="selection-area no-print">
                    <div class="step-box">
                        <h2>1. è–¬å‰¤ã‚’é¸æŠ</h2>
                        <div class="btn-group-custom" id="drug-buttons">
                            <button class="custom-btn" onclick="setACDrug('warfarin', this)">ãƒ¯ãƒ¼ãƒ•ã‚¡ãƒªãƒ³</button>
                            <button class="custom-btn" onclick="setACDrug('doac_pe', this)">DOACï¼šãƒ—ãƒ©ã‚¶ã‚­ã‚µ / ã‚¨ãƒªã‚­ãƒ¥ãƒ¼ã‚¹</button>
                            <button class="custom-btn" onclick="setACDrug('doac_il', this)">DOACï¼šã‚¤ã‚°ã‚¶ãƒ¬ãƒ«ãƒˆ / ãƒªã‚¯ã‚·ã‚¢ãƒŠ</button>
                            <button class="custom-btn" onclick="setACDrug('platelet_main', this)">æŠ—è¡€å°æ¿è–¬ï¼šãƒã‚¤ã‚¢ã‚¹ãƒ”ãƒªãƒ³/ãƒ‘ãƒŠãƒ«ã‚¸ãƒ³/ã‚¯ãƒ­ãƒ”ãƒ‰ã‚°ãƒ¬ãƒ«/ã‚¨ãƒ•ã‚£ã‚¨ãƒ³ãƒˆ</button>
                            <button class="custom-btn" onclick="setACDrug('platelet_cilo', this)">æŠ—è¡€å°æ¿è–¬ï¼šã‚·ãƒ­ã‚¹ã‚¿ã‚¾ãƒ¼ãƒ«</button>
                        </div>
                    </div>
                    <div class="step-box">
                        <h2>2. æ‰‹è¡“ãƒ»å‡¦ç½®ã‚’é¸æŠ</h2>
                        <div class="btn-group-custom" id="surgery-buttons">
                            <button class="custom-btn" onclick="setACSurgery('dental', this)">æŠœæ­¯ãƒ»ç™½å†…éšœï¼ˆå±€æ‰€éº»é…”ï¼‰</button>
                            <button class="custom-btn" onclick="setACSurgery('minor', this)">ä½“è¡¨ã®å°æ‰‹è¡“ï¼ˆåœ§è¿«ç­‰å®¹æ˜“ï¼‰</button>
                            <button class="custom-btn" onclick="setACSurgery('major', this)">åœ§è¿«ãŒå›°é›£ãªå ´åˆã€å¤§æ‰‹è¡“</button>
                            <button class="custom-btn" onclick="setACSurgery('spinal', this)">è„Šé«„ãƒ»ç¡¬è†œå¤–éº»é…” / ã‚«ãƒ†ãƒ¼ãƒ†ãƒ«æŠœå»</button>
                        </div>
                    </div>
                </div>
                <div id="ac-result-area" style="display:none;">
                    <h3 style="text-align:center; margin-bottom:20px;">æ¨å¥¨ã•ã‚Œã‚‹å¯¾å¿œï¼ˆç—…æ…‹ãƒªã‚¹ã‚¯åˆ¥ï¼‰</h3>
                    <div class="comparison-container">
                        <div class="risk-col risk-high">
                            <div class="risk-title">é«˜ãƒªã‚¹ã‚¯ç—…æ…‹</div>
                            <div class="definition-box" id="high-risk-def"></div>
                            <div class="action-box">
                                <div id="high-risk-action"></div>
                                <div id="high-schedule" class="schedule-info" style="display:none;"></div>
                            </div>
                        </div>
                        <div class="risk-col risk-low">
                            <div class="risk-title">ä½ãƒªã‚¹ã‚¯ç—…æ…‹</div>
                            <div class="definition-box" id="low-risk-def"></div>
                            <div class="action-box">
                                <div id="low-risk-action"></div>
                                <div id="low-schedule" class="schedule-info" style="display:none;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="footer-info" id="footer-note" style="display:none;">
                        <div class="footer-title">â˜… å†é–‹ãƒ»ãƒ˜ãƒ‘ãƒªãƒ³ç½®æ›ã«é–¢ã™ã‚‹æ³¨æ„</div>
                        <div id="footer-text"></div>
                    </div>
                </div>
                
                <div class="text-end no-print mb-3 mt-3">
                    <button class="btn btn-success" onclick="window.print()">ã“ã®ãƒšãƒ¼ã‚¸ã‚’å°åˆ·</button>
                </div>

                <details open class="no-print">
                    <summary>ï¼ˆå‚è€ƒï¼‰ä¼‘è–¬ãƒ»ç½®æ›ãƒ—ãƒ­ãƒˆã‚³ãƒ«å…¨å›³è¡¨</summary>
                    <div class="table-container">
                        <table class="ref-table">
                            <thead><tr class="bg-header"><th class="col-drug">è–¬å‰¤</th><th class="col-risk">ãƒªã‚¹ã‚¯åˆ†é¡ãƒ»å®šç¾©</th><th class="col-surg-sm">æŠœæ­¯ãƒ»ç™½å†…éšœ</th><th class="col-surg-sm">ä½“è¡¨ã®å°æ‰‹è¡“<br>(åœ§è¿«ãŒå®¹æ˜“)</th><th class="col-surg-lg">åœ§è¿«å›°é›£ãªå ´åˆ<br>å¤§æ‰‹è¡“</th><th class="col-surg-lg">è„Šé«„ãƒ»ç¡¬è†œå¤–éº»é…”<br>ã‚«ãƒ†ãƒ¼ãƒ†ãƒ«æŠœå»</th></tr></thead>
                            <tbody>
                                <tr class="bg-warfarin"><td rowspan="2" class="txt-center txt-bold no-wrap">ãƒ¯ãƒ¼ãƒ•ã‚¡ãƒªãƒ³</td><td><span class="txt-bold">é«˜ãƒªã‚¹ã‚¯ç—…æ…‹</span><div class="risk-list"><div class="hanging-item">ãƒ»å¿ƒåŸæ€§è„³å¡æ “ç—‡ã®æ—¢å¾€</div><div class="hanging-item">ãƒ»å¼è†œç—‡ã‚’åˆä½µã™ã‚‹å¿ƒæˆ¿ç´°å‹•</div><div class="hanging-item">ãƒ»å¼è†œç—‡ã§ã¯ãªã„ãŒè„³å’ä¸­ã®é«˜ãƒªã‚¹ã‚¯å¿ƒæˆ¿ç´°å‹•</div><div class="hanging-item">ãƒ»æ©Ÿæ¢°å¼ç½®æ›è¡“å¾Œã®è¡€æ “å¡æ “ç—‡ã®æ—¢å¾€</div><div class="hanging-item">ãƒ»åƒ§å¸½å¼ã®æ©Ÿæ¢°å¼ç½®æ›è¡“å¾Œ</div><div class="hanging-item">ãƒ»æŠ—ãƒªãƒ³è„‚è³ªæŠ—ä½“ç—‡å€™ç¾¤</div><div class="hanging-item">ãƒ»æ·±éƒ¨é™è„ˆè¡€æ “ç—‡ãƒ»è‚ºå¡æ “ç—‡</div></div></td><td rowspan="2" class="txt-center"><span class="txt-bold">ç¶™ç¶šä¸‹ã§ã®æ–½è¡Œæ¨å¥¨</span><br>(æ²»ç™‚åŸŸå†…ç¢ºèª)<br><br>â€»ã‚«ãƒ†ãƒ¼ãƒ†ãƒ«ç•™ç½®ã¯ã‚„ã‚€ã‚’å¾—ãªã„å ´åˆã€ç•™ç½®ä¸­ã¯INR&lt;3.0</td><td rowspan="2" class="txt-center"><span class="txt-bold">ä¼‘è–¬ãªã—</span><br>(æ²»ç™‚åŸŸå†…ç¢ºèª)</td><td><span class="txt-bold no-wrap">ã€ä¼‘è–¬ã€‘3ï½5æ—¥</span><div class="heparin-note">ä¸­æ­¢ç¿Œæ—¥ã‚ˆã‚Šãƒ˜ãƒ‘ãƒªãƒ³ç½®æ›</div></td><td><span class="txt-bold no-wrap">ã€ä¼‘è–¬ã€‘5æ—¥</span><div class="heparin-note">ä¸­æ­¢ç¿Œæ—¥ã‚ˆã‚Šãƒ˜ãƒ‘ãƒªãƒ³ç½®æ›</div><br>ç©¿åˆºå‰: PT-INR&lt;1.2<br>æŠœå»æ™‚: INR&lt;1.5</td></tr>
                                <tr class="bg-warfarin"><td><span class="txt-bold">ä½ãƒªã‚¹ã‚¯ç—…æ…‹</span><div class="risk-list"><div class="hanging-item">å·¦è¨˜ä»¥å¤–</div></div></td><td><span class="txt-bold no-wrap">ã€ä¼‘è–¬ã€‘3ï½5æ—¥</span></td><td>ç©¿åˆºå‰: PT-INR&lt;1.2ã‚’ç¢ºèª<br>(ä½ãƒªã‚¹ã‚¯ç¾¤ã§ã¯ä¼‘è–¬ãªã—)</td></tr>
                                <tr class="bg-doac"><td rowspan="2" class="txt-center txt-bold"><span class="no-wrap">DOAC</span><span class="drug-list no-wrap"><span class="drug-item">ãƒ—ãƒ©ã‚¶ã‚­ã‚µ</span><span class="drug-item">ã‚¤ã‚°ã‚¶ãƒ¬ãƒ«ãƒˆ</span><span class="drug-item">ã‚¨ãƒªã‚­ãƒ¥ãƒ¼ã‚¹</span><span class="drug-item">ãƒªã‚¯ã‚·ã‚¢ãƒŠ</span></span></td><td><span class="txt-bold">é«˜ãƒªã‚¹ã‚¯ç—…æ…‹</span><div class="risk-list"><div class="hanging-item">ãƒ¯ãƒ¼ãƒ•ã‚¡ãƒªãƒ³ã«æº–ãšã‚‹</div></div></td><td rowspan="2" class="txt-center"><span class="txt-bold">ç¶™ç¶šä¸‹ã§ã®æ–½è¡Œæ¨å¥¨</span></td><td rowspan="2"><span class="txt-bold no-wrap">ã€ä¼‘è–¬ã€‘1æ—¥</span><br><span style="font-size:0.75rem">â€»ãƒ—ãƒ©ã‚¶ã‚­ã‚µ: ç¶™ç¶šä¸‹ã§æ–½è¡Œã™ã‚‹ãŒã€trough aPTT>80ç§’ã®å ´åˆã¯ç·Šæ€¥æ€§ã®ãªã„æ‰‹è¡“ã¯é¿ã‘ã‚‹</span></td><td><span class="txt-bold no-wrap">ã€ä¼‘è–¬ã€‘</span><br>â—ãƒ—ãƒ©ã‚¶ã‚­ã‚µãƒ»ã‚¨ãƒªã‚­ãƒ¥ãƒ¼ã‚¹: <span class="txt-bold">2æ—¥</span><br>â—ã‚¤ã‚°ã‚¶ãƒ¬ãƒ«ãƒˆãƒ»ãƒªã‚¯ã‚·ã‚¢ãƒŠ: <span class="txt-bold">1æ—¥</span><div class="heparin-note">ãƒ—ãƒ©ã‚¶ã‚­ã‚µãƒ»ã‚¨ãƒªã‚­ãƒ¥ãƒ¼ã‚¹: æœ€çµ‚æŠ•ä¸12æ™‚é–“å¾Œã‚ˆã‚Šãƒ˜ãƒ‘ãƒªãƒ³ç½®æ›<br>ã‚¤ã‚°ã‚¶ãƒ¬ãƒ«ãƒˆãƒ»ãƒªã‚¯ã‚·ã‚¢ãƒŠ: æœ€çµ‚æŠ•ä¸24æ™‚é–“å¾Œã‚ˆã‚Šãƒ˜ãƒ‘ãƒªãƒ³ç½®æ›</div></td><td><span class="txt-bold no-wrap">ã€ä¼‘è–¬ã€‘</span><br>â—ãƒ—ãƒ©ã‚¶ã‚­ã‚µ: 4æ—¥(CCrâ‰§60)ï½5æ—¥(30&lt;CCr&lt;60)<br>â—ã‚¨ãƒªã‚­ãƒ¥ãƒ¼ã‚¹: 3æ—¥<br>â—ã‚¤ã‚°ã‚¶ãƒ¬ãƒ«ãƒˆãƒ»ãƒªã‚¯ã‚·ã‚¢ãƒŠ: 2æ—¥<div class="heparin-note">(ç½®æ›é–‹å§‹æ™‚æœŸã¯å·¦è¨˜ã¨åŒæ§˜)<br>æŠœå»: APTTæ­£å¸¸å¯¾ç…§1.5å€æœªæº€</div></td></tr>
                                <tr class="bg-doac"><td><span class="txt-bold">ä½ãƒªã‚¹ã‚¯ç—…æ…‹</span><div class="risk-list"><div class="hanging-item">ãƒ¯ãƒ¼ãƒ•ã‚¡ãƒªãƒ³ã«æº–ãšã‚‹</div></div></td><td class="txt-center"><span class="txt-bold">åŒä¸Š</span></td><td>ä½ãƒªã‚¹ã‚¯ç¾¤ã§ã¯å‡ºè¡€æ™‚ã«åœ§è¿«ã«ã‚ˆã‚‹æ­¢è¡€å¯¾å¿œãŒå¯èƒ½ã§ã‚ã‚‹ã“ã¨ã‹ã‚‰ã€ä»®ã«ä¼‘è–¬ã™ã‚‹å ´åˆã«ã¯ä¼‘è–¬æœŸé–“ã‚’åŠæ¸›æœŸã®2å€ç¨‹åº¦ã«ç•™ã‚ã‚‹ã“ã¨ãŒåˆç†çš„ã§ã‚ã‚‹</td></tr>
                                <tr class="bg-platelet"><td rowspan="2" class="txt-center txt-bold"><span class="no-wrap">æŠ—è¡€å°æ¿è–¬</span><span class="drug-list no-wrap"><span class="drug-item">ãƒã‚¤ã‚¢ã‚¹ãƒ”ãƒªãƒ³</span><span class="drug-item">ãƒ‘ãƒŠãƒ«ã‚¸ãƒ³</span><span class="drug-item">ã‚¯ãƒ­ãƒ”ãƒ‰ã‚°ãƒ¬ãƒ«</span><span class="drug-item">ã‚¨ãƒ•ã‚£ã‚¨ãƒ³ãƒˆ</span><span class="drug-item">ã‚·ãƒ­ã‚¹ã‚¿ã‚¾ãƒ¼ãƒ«</span></span></td><td><span class="txt-bold">é«˜ãƒªã‚¹ã‚¯ç—…æ…‹</span><div class="risk-list"><div class="hanging-item">ãƒ»å† å‹•è„ˆã‚¹ãƒ†ãƒ³ãƒˆç•™ç½®å¾Œ2ãƒ¶æœˆä»¥å†…</div><div class="hanging-item">ãƒ»å† å‹•è„ˆè–¬å‰¤æº¶å‡ºæ€§ã‚¹ãƒ†ãƒ³ãƒˆç•™ç½®å¾Œ12ãƒ¶æœˆä»¥å†…</div><div class="hanging-item">ãƒ»è„³è¡€è¡Œå†å»ºè¡“å¾Œ2ãƒ¶æœˆä»¥å†…</div><div class="hanging-item">ãƒ»ä¸»å¹¹å‹•è„ˆã«50%ä»¥ä¸Šã®ç‹­çª„ã‚’ä¼´ã†è„³æ¢—å¡åˆã¯ä¸€éæ€§è„³è™šè¡€ç™ºä½œ</div><div class="hanging-item">ãƒ»æœ€è¿‘ç™ºç—‡ã—ãŸè™šè¡€æ€§è„³å’ä¸­åˆã¯ä¸€éæ€§è„³è™šè¡€ç™ºä½œ</div><div class="hanging-item">ãƒ»é–‰å¡æ€§å‹•è„ˆç¡¬åŒ–ç—‡ã§Fontaine3åº¦(å®‰é™æ™‚ç–¼ç—›)ä»¥ä¸Š</div><div class="hanging-item">ãƒ»é ¸å‹•è„ˆã‚¨ã‚³ãƒ¼/é ­é ¸éƒ¨MRIã§ä¼‘è–¬å±é™ºæ‰€è¦‹</div></div></td><td rowspan="2" class="txt-center"><span class="txt-bold">ç¶™ç¶šä¸‹ã§ã®æ–½è¡Œã‚’åŸå‰‡ã¨ã™ã‚‹</span></td><td rowspan="2" class="txt-center"><span class="txt-bold">ç¶™ç¶šä¸‹ã§ã®æ–½è¡Œã‚’åŸå‰‡ã¨ã™ã‚‹</span></td><td><span class="txt-bold no-wrap">ã€ä¼‘è–¬ã€‘</span><br>â—ä¸»è¦è–¬: <span class="txt-bold">7æ—¥</span><br>â—ã‚·ãƒ­ã‚¹ã‚¿ã‚¾ãƒ¼ãƒ«: <span class="txt-bold">2æ—¥</span><div class="heparin-note">ä¸­æ­¢ç¿Œæ—¥ã‚ˆã‚Šãƒ˜ãƒ‘ãƒªãƒ³ç½®æ›</div></td><td><span class="txt-bold no-wrap">ã€ä¼‘è–¬ã€‘</span><br>ï¼ˆåŒå·¦ï¼‰<div class="heparin-note">(å¿…è¦ã«å¿œã˜ã¦ã€)<br>ä¸­æ­¢ç¿Œæ—¥ã‚ˆã‚Šãƒ˜ãƒ‘ãƒªãƒ³ç½®æ›<br>æŠœå»: APTTæ­£å¸¸å¯¾ç…§1.5å€æœªæº€</div></td></tr>
                                <tr class="bg-platelet"><td><span class="txt-bold">ä½ãƒªã‚¹ã‚¯ç—…æ…‹</span><div class="risk-list"><div class="hanging-item">å·¦è¨˜ä»¥å¤–</div></div></td><td><span class="txt-bold no-wrap">ã€ä¼‘è–¬ã€‘åŒä¸Š</span><br><div class="heparin-note">å ´åˆã«ã‚ˆã£ã¦ã€ä¸­æ­¢ç¿Œæ—¥ã‚ˆã‚Šãƒ˜ãƒ‘ãƒªãƒ³ç½®æ›</div></td><td class="txt-center">ä½ãƒªã‚¹ã‚¯ç¾¤ã§ã¯ä¼‘è–¬ãªã—</td></tr>
                            </tbody>
                        </table>
                        <div class="bottom-notes"><div class="note-block"><div class="note-title">ãƒ˜ãƒ‘ãƒªãƒ³ç½®æ›ã‚’è¡Œã£ãŸå ´åˆã®ãƒ˜ãƒ‘ãƒªãƒ³ä¸­æ­¢æ™‚æœŸ</div><div><strong>ãƒ¯ãƒ¼ãƒ•ã‚¡ãƒªãƒ³ï¼š</strong>ãƒ¯ãƒ¼ãƒ•ã‚¡ãƒªãƒ³å†é–‹1ã€œ2æ—¥å¾Œã«ä¸­æ­¢ï¼ˆä¸­æ­¢æ™‚åŠ¹æœç¢ºèªï¼‰ã€‚ï¼ˆå†é–‹5æ—¥ç›®ä»¥é™ã€è‡³é©INRå›å¾©ã®ç¢ºèªã‚’è¡Œã†ï¼‰</div><div style="margin-top:5px;"><strong>DOACï¼š</strong><br>ãƒ»æŒç¶šé™æ³¨æ™‚ï¼ˆæœªåˆ†ç”»ãƒ˜ãƒ‘ãƒªãƒ³ï¼‰ï¼šDOACæŠ•ä¸é–‹å§‹æ™‚ã«ä¸­æ­¢ã€‚<br>ãƒ»çš®ä¸‹æ³¨æ™‚ï¼ˆã‚¯ãƒ¬ã‚­ã‚µãƒ³ç­‰ï¼‰ï¼š<br>&nbsp;&nbsp;ãƒ—ãƒ©ã‚¶ã‚­ã‚µã¯æ¬¡å›çš®ä¸‹æ³¨è£½å‰¤æŠ•ä¸2æ™‚é–“å‰ã«æŠ•ä¸é–‹å§‹ã€æ¬¡å›çš®ä¸‹æ³¨è£½å‰¤ã®æŠ•ä¸ä¸­æ­¢ã€‚<br>&nbsp;&nbsp;ã‚¤ã‚°ã‚¶ãƒ¬ãƒ«ãƒˆã¯æ¬¡å›çš®ä¸‹æ³¨è£½å‰¤æŠ•ä¸0ã€œ2æ™‚é–“å‰ã«æŠ•ä¸é–‹å§‹ã€‚<br>&nbsp;&nbsp;ã‚¨ãƒªã‚­ãƒ¥ãƒ¼ã‚¹/ãƒªã‚¯ã‚·ã‚¢ãƒŠã¯æ¬¡å›çš®ä¸‹æ³¨è£½å‰¤æŠ•ä¸æ™‚é–“ã«æŠ•ä¸é–‹å§‹ã€‚</div><div style="margin-top:5px;"><strong>æŠ—è¡€å°æ¿å‰¤ï¼š</strong>å†é–‹3ã€œ4æ—¥å¾Œã«ä¸­æ­¢</div></div><div style="text-align:right; margin-top:10px; color:#666;">å‡ºå…¸ï¼š2013.06 è–¬äº‹å§”å“¡ä¼šä½œæˆ / 2018.10 æ”¹è¨‚</div></div>
                    </div>
                </details>
            </div>
        </div>
    </div>
</div>

<div id="previewModal" class="modal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5>å°åˆ·ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h5>
                <button type="button" class="btn-close" onclick="closeModal()">Ã—</button>
            </div>
            <div class="modal-body" style="background:#ccc; overflow:auto; max-height:80vh;">
                <div id="previewContent" style="background:white; margin:20px auto; padding:20px; box-shadow:0 0 10px rgba(0,0,0,0.3); width:210mm; min-height:297mm;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">é–‰ã˜ã‚‹</button>
                <button type="button" class="btn btn-primary" onclick="printFromPreview()">ã“ã®ã¾ã¾å°åˆ·</button>
            </div>
        </div>
    </div>
</div>

<script>
function switchTab(tabId) {
    document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.nav-link').forEach(el => {
        if(el.getAttribute('onclick').includes(tabId)) el.classList.add('active');
    });
    document.querySelectorAll('.tab-pane').forEach(el => {
        el.classList.remove('show', 'active');
        el.style.display = 'none';
    });
    const target = document.getElementById(tabId);
    if(target) {
        target.classList.add('show', 'active');
        target.style.display = 'block';
    }
    if(tabId === 'master-tab') filterMasterTable();
}
function toggleMenu() {
    var menu = document.getElementById('menu-content');
    menu.classList.toggle('active');
}
function showPreview() {
    const activeTab = document.querySelector('.tab-pane.active').id;
    let content = "";
    if(activeTab === "check-tab") {
        const header = document.querySelector("#check-tab .print-header").outerHTML;
        const table = document.getElementById("resultTable").outerHTML;
        const refs = document.getElementById("printCitationList").outerHTML;
        content = `${header}${table}<div class="mt-4 pt-2 border-top"><small class="fw-bold">ã€å¼•ç”¨ãƒ»æ ¹æ‹ ã€‘</small>${refs}</div>`;
    } else if(activeTab === "schedule-tab") {
        content = document.querySelector("#schedule-tab .print-header").outerHTML + document.getElementById("scheduleResultArea").innerHTML;
    } else {
        content = "<p class='p-3'>ã“ã®ç”»é¢ã¯ã€Œå°åˆ·ã€ãƒœã‚¿ãƒ³ã‹ã‚‰ç›´æ¥å°åˆ·ã—ã¦ãã ã•ã„ã€‚</p>";
    }
    document.getElementById("previewContent").innerHTML = content;
    document.getElementById("previewModal").style.display = "block";
}
function closeModal() {
    document.getElementById("previewModal").style.display = "none";
}
function printFromPreview() {
    closeModal();
    setTimeout(() => { window.print(); }, 300);
}
window.onscroll = function() {
    const btn = document.getElementById("backToTop");
    if (document.body.scrollTop > 200 || document.documentElement.scrollTop > 200) {
        btn.style.display = "block";
    } else {
        btn.style.display = "none";
    }
};

const citations = {
    "1": "ç³–å°¿ç—…æ²»ç™‚ã«ãŠã‘ã‚‹SGLT2é˜»å®³è–¬ã®é©æ­£ä½¿ç”¨ã«é–¢ã™ã‚‹ Recommendation",
    "2": "æ‰‹è¡“ãªã©ã‚’è¡Œã†éš›ã®æŠ—å‡å›ºè–¬ãƒ»æŠ—è¡€å°æ¿è–¬å–ã‚Šæ‰±ã„ã®å‚è€ƒç›®å®‰(é™¢å†…ãƒãƒ¼ã‚¿ãƒ«)",
    "3": "æ·»ä»˜æ–‡æ›¸",
    "4": "éª¨å¸åæŠ‘åˆ¶è–¬é–¢é€£é¡éª¨å£Šæ­»ã®ç—…æ…‹ã¨ç®¡ç† : é¡éª¨å£Šæ­»æ¤œè¨å§”å“¡ä¼šãƒã‚¸ã‚·ãƒ§ãƒ³ãƒšãƒ¼ãƒ‘ãƒ¼ 2016",
    "5": "NCCNã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ï¼šçµè…¸ç™Œã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ãƒ»ç›´è…¸ç™Œã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³",
    "6": "åŒ»è–¬å“é©æ­£ä½¿ç”¨ã‚¬ã‚¤ãƒ‰",
    "7": "åŒ»è–¬å“ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ãƒ•ã‚©ãƒ¼ãƒ ",
    "8": "è£½è–¬ä¼æ¥­ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸",
    "9": "å½“é™¢ä»£è¬å†…åˆ†æ³Œå†…ç§‘ã‚ˆã‚Š",
    "10": "å¿ƒä¸å…¨æ²»ç™‚ã«ãŠã‘ã‚‹SGLT2é˜»å®³è–¬ã®é©æ­£ä½¿ç”¨ã«é–¢ã™ã‚‹Recommendation",
    "11": "èµ¤æœ¨æ™‹ä»‹ï¼ˆç·¨ï¼‰, å‘¨è¡“æœŸã®å®‰å…¨ãªè–¬å‰¤ç®¡ç†ã‚’è€ƒãˆã‚‹ä¼šï¼ˆåŸ·ç­†ï¼‰. è¡“å‰ä¼‘è–¬ã‚¯ã‚¤ãƒƒã‚¯ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹."
};

// VBAç½®æ›ç”¨ãƒãƒ¼ã‚«ãƒ¼
const rawMasterData = `
åˆ†é¡	åˆ†é¡2	å•†å“å	ä¸€èˆ¬å	ä¼‘è–¬æœŸé–“	å¼•ç”¨	ä¼‘è–¬ç†ç”±
é™åœ§è–¬	ACEé˜»å®³è–¬	ã‚¢ãƒ‡ã‚«ãƒƒãƒˆ	ãƒ‡ãƒ©ãƒ—ãƒªãƒ«	24æ™‚é–“å‰	3	è¡“ä¸­è¡€åœ§ä½ä¸‹ã®ãƒªã‚¹ã‚¯
é™åœ§è–¬	ACEé˜»å®³è–¬	ã‚¨ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ«	ãƒ†ãƒ¢ã‚«ãƒ—ãƒªãƒ«	24æ™‚é–“å‰	3	è¡“ä¸­è¡€åœ§ä½ä¸‹ã®ãƒªã‚¹ã‚¯
`; // DATA_MARKER_END

let masterData = [];

function init() {
    parseMasterData(rawMasterData);
    
    const citationListEl = document.getElementById("citationList");
    const printCitationListEl = document.getElementById("printCitationList");
    let cHtml = "";
    for (const [key, val] of Object.entries(citations)) {
        cHtml += `<li class="citation-item">[${key}] ${val}</li>`;
    }
    citationListEl.innerHTML = `<ul class="citation-list">${cHtml}</ul>`;
    printCitationListEl.innerHTML = `<ul class="citation-list">${cHtml}</ul>`;

    filterMasterTable();
}

function parseMasterData(rawData) {
    masterData = [];
    const lines = rawData.trim().split("\n");
    let isHeaderFound = false;
    for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        if(!line) continue;
        if (line.startsWith("åˆ†é¡")) { isHeaderFound = true; continue; }
        if (!isHeaderFound) continue;
        const cols = line.split("\t");
        if (cols.length < 3) continue;
        masterData.push({
            type: cols[0] || "",
            type2: cols[1] || "",
            brandName: cols[2] || "",
            genericName: cols[3] || "",
            period: cols[4] || "",
            ref: cols[5] || "",
            reason: cols[6] || ""
        });
    }
}

const ngKeywords = ["è–¬åŠ¹åç§°", "é™¢å†…", "åˆ†ï¼‘", "åˆ†ï¼’", "åˆ†ï¼“", "åˆ†ï¼”", "åˆ†ï¼•", "ï¼‘æ—¥", "1æ—¥", "å›", "é£Ÿå¾Œ", "é£Ÿå‰", "æœ", "æ˜¼", "å¤•", "çœ å‰", "Rp", "ï¼²ï½", "RP", "rp"];
const externalKeywords = ["ç‚¹çœ¼", "çœ¼è»Ÿè†", "è»Ÿè†", "ã‚¯ãƒªãƒ¼ãƒ ", "ã‚²ãƒ«", "ãƒ­ãƒ¼ã‚·ãƒ§ãƒ³", "ãƒ‘ãƒƒãƒ—", "è²¼ä»˜", "ãƒ†ãƒ¼ãƒ—", "åå‰¤", "åè–¬", "ç‚¹é¼»", "å¸å…¥", "ãƒˆãƒ­ãƒ¼ãƒ", "ã†ãŒã„", "æ‡¸æ¿æ€§"];
const externalForms_ClipAfter = ["æ‡¸æ¿æ€§ç‚¹çœ¼æ¶²", "é…åˆç‚¹çœ¼æ¶²", "ç‚¹çœ¼æ¶²", "çœ¼è»Ÿè†", "è»Ÿè†å‰¤", "è²¼ä»˜å‰¤", "å¸å…¥æ¶²", "å¸å…¥å‰¤", "ç‚¹é¼»æ¶²", "ç‚¹é¼»å‰¤", "ã‚¯ãƒªãƒ¼ãƒ ", "ãƒ­ãƒ¼ã‚·ãƒ§ãƒ³", "ã†ãŒã„è–¬", "ãƒˆãƒ­ãƒ¼ãƒ", "ãƒ‘ãƒƒãƒ—", "ã‚²ãƒ«", "è»Ÿè†", "åå‰¤", "åè–¬"];
const oralForms_ClipBefore = ["å£è…”å†…å´©å£ŠéŒ ", "ãƒ‰ãƒ©ã‚¤ã‚·ãƒ­ãƒƒãƒ—", "ãƒãƒ¥ã‚¢ãƒ–ãƒ«éŒ ", "é…åˆé¡†ç²’", "è»Ÿã‚«ãƒ—ã‚»ãƒ«", "ç¡¬ã‚«ãƒ—ã‚»ãƒ«", "å¡©é…¸å¡©éŒ ", "ç¡«é…¸å¡©éŒ ", "ãƒªãƒ³é…¸å¡©éŒ ", "ãƒãƒ¬ã‚¤ãƒ³é…¸å¡©éŒ ", "ã‚¯ã‚¨ãƒ³é…¸å¡©éŒ ", "ãƒ•ãƒãƒ«é…¸å¡©éŒ ", "ãƒŠãƒˆãƒªã‚¦ãƒ éŒ ", "ã‚«ãƒªã‚¦ãƒ éŒ ", "ã‚«ãƒ«ã‚·ã‚¦ãƒ éŒ ", "å¡©é…¸å¡©ã‚«ãƒ—ã‚»ãƒ«", "ç¡«é…¸å¡©ã‚«ãƒ—ã‚»ãƒ«", "ãƒªãƒ³é…¸å¡©ã‚«ãƒ—ã‚»ãƒ«", "ãƒãƒ¬ã‚¤ãƒ³é…¸å¡©ã‚«ãƒ—ã‚»ãƒ«", "ãƒŠãƒˆãƒªã‚¦ãƒ ã‚«ãƒ—ã‚»ãƒ«", "é…åˆéŒ ", "ï¼¯ï¼¤éŒ ", "ã‚«ãƒ—ã‚»ãƒ«", "é¡†ç²’å‰¤", "ç´°ç²’å‰¤", "ã‚·ãƒ­ãƒƒãƒ—", "é¡†ç²’", "ç´°ç²’", "æ•£å‰¤", "éŒ ", "æ•£", "å¡©é…¸å¡©", "ç¡«é…¸å¡©", "ãƒªãƒ³é…¸å¡©", "ãƒãƒ¬ã‚¤ãƒ³é…¸å¡©", "ã‚¯ã‚¨ãƒ³é…¸å¡©", "ãƒ•ãƒãƒ«é…¸å¡©", "ãƒŠãƒˆãƒªã‚¦ãƒ ", "ã‚«ãƒªã‚¦ãƒ ", "ã‚«ãƒ«ã‚·ã‚¦ãƒ "];

function cleanDrugName(rawText) {
    if (!rawText || rawText.trim() === "") return null;
    let fullDrugName = rawText.trim();
    fullDrugName = fullDrugName.replace(/ï¼ˆ[^ï¼‰]+ï¼‰/g, "").replace(/^[\sã€€]+/, "");
    const splitMatch = fullDrugName.match(/^([^\sã€€ã€Œ]+)/);
    if(splitMatch) { fullDrugName = splitMatch[1]; }
    fullDrugName = fullDrugName.replace("â˜…", "").replace("ï¼ˆåŒ»ç™‚ç”¨ï¼‰", "");
    fullDrugName = fullDrugName.replace(/[A-Za-z0-9]/g, s => String.fromCharCode(s.charCodeAt(0) + 0xFEE0));

    let processedName = fullDrugName;
    let isExternal = externalKeywords.some(k => fullDrugName.includes(k));
    if (isExternal) {
        for (const form of externalForms_ClipAfter) {
            const pos = fullDrugName.indexOf(form);
            if (pos !== -1) { processedName = fullDrugName.substring(0, pos + form.length); break; }
        }
    } else {
        for (const form of oralForms_ClipBefore) {
            const pos = fullDrugName.indexOf(form);
            if (pos !== -1) { processedName = fullDrugName.substring(0, pos); break; }
        }
    }
    return processedName.trim();
}

function processData() {
    const rawInput = document.getElementById("rawInput").value;
    const surgeryDateStr = document.getElementById("surgeryDate").value;
    const resultTableBody = document.querySelector("#resultTable tbody");
    const hasDate = !!surgeryDateStr;

    const dateText = hasDate ? new Date(surgeryDateStr).toLocaleDateString('ja-JP', {year:'numeric', month:'2-digit', day:'2-digit'}) : "æœªè¨­å®š";
    document.getElementById("printDateDisplay").textContent = "æ‰‹è¡“äºˆå®šæ—¥ï¼š" + dateText;
    const colHeader = document.querySelector(".col-calc");
    if(colHeader) colHeader.style.display = hasDate ? "" : "none";

    resultTableBody.innerHTML = "";
    
    const lines = rawInput.split("\n");
    
    let hasRp = false;
    let hasIndent = false;
    
    for (const line of lines) {
        if (/Rp|ï¼²ï½|RP|rp/i.test(line)) { hasRp = true; break; }
        const checkStr = line.replace(/ã€€/g, " ");
        const blankCount = checkStr.length - checkStr.trimStart().length;
        if (blankCount >= 2 && line.trim() !== "") { hasIndent = true; }
    }
    
    let mode = "Simple";
    if (hasRp) { mode = "StrictRp"; } else if (hasIndent) { mode = "Indent"; }

    let isPrevRp = false;
    let hasData = false;

    lines.forEach(line => {
        const trimmedLine = line.trim();
        let shouldKeep = false;
        
        if (trimmedLine !== "") {
            if (mode === "StrictRp") {
                const isCurrentRp = /Rp|ï¼²ï½|RP|rp/i.test(line);
                if (isPrevRp && !isCurrentRp) { shouldKeep = true; }
                isPrevRp = isCurrentRp;
            } else if (mode === "Indent") {
                const checkStr = line.replace(/ã€€/g, " ");
                const blankCount = checkStr.length - checkStr.trimStart().length;
                const isNG = ngKeywords.some(ng => line.includes(ng));
                if (blankCount >= 2 && !isNG) { shouldKeep = true; }
            } else {
                const isNG = ngKeywords.some(ng => line.includes(ng));
                if (!isNG) { shouldKeep = true; }
            }
            
            if (shouldKeep) {
                const cleanedName = cleanDrugName(line);
                if (cleanedName) {
                    hasData = true;
                    const match = masterData.find(d => d.brandName.startsWith(cleanedName) || d.genericName === cleanedName);
                    const tr = document.createElement("tr");

                    if (match) {
                        let rowClass = "";
                        let calcText = "-";
                        
                        if (match.period.includes("é™¢å†…æ¨å¥¨æœŸé–“ãªã—")) {
                             rowClass = "row-gray";
                             calcText = "é™¢å†…æ¨å¥¨æœŸé–“ãªã—";
                        } else {
                            const testCalc = calculateStopDateStrict(match.period, "2025-01-01");
                            if (testCalc.alert || match.period.includes("è³‡æ–™")) {
                                rowClass = "row-alert";
                            } else {
                                rowClass = "row-none";
                            }
                        }

                        if (hasDate && !match.period.includes("é™¢å†…æ¨å¥¨æœŸé–“ãªã—")) {
                            const calc = calculateStopDateStrict(match.period, surgeryDateStr);
                            calcText = calc.text;
                        } else if (!hasDate && rowClass === "row-alert") {
                            calcText = match.period;
                        }

                        tr.className = rowClass;
                        tr.innerHTML = `<td class="fw-bold">${cleanedName}</td><td class="small">${match.type}</td><td class="small">${match.period}</td><td class="fw-bold" style="${hasDate?'':'display:none;'}">${calcText}</td><td class="small">${match.reason}</td><td class="small text-center">${match.ref}</td>`;
                    } else {
                        tr.className = "row-none";
                        tr.innerHTML = `<td>${cleanedName}</td><td class="small text-muted">-</td><td class="small text-muted">æŒ‡å®šãªã—</td><td class="small text-muted" style="${hasDate?'':'display:none;'}">-</td><td class="small text-muted">æŒ‡å®šãªã—</td><td class="small text-muted">-</td>`;
                    }
                    resultTableBody.appendChild(tr);
                }
            }
        }
    });

    if (!hasData) resultTableBody.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-4">æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãªã—</td></tr>';
}

function calculateStopDateStrict(period, sDateStr) {
    const sDate = new Date(sDateStr);
    const fmt = (d) => `${d.getMonth()+1}/${d.getDate()}`;
    const addDay = (d, n) => { const x = new Date(d); x.setDate(x.getDate() + n); return x; };
    
    if (period === "1ï½3æ—¥") return { text: `${fmt(addDay(sDate, -3))}ï½${fmt(addDay(sDate, -1))}`, alert: true };
    if (period === "1æ—¥å‰") return { text: fmt(addDay(sDate, -1)), alert: true };
    if (period === "1é€±é–“") return { text: fmt(addDay(sDate, -7)), alert: true };
    if (period === "24 æ™‚é–“ä»¥ä¸Š") return { text: `${fmt(sDate)} æ‰‹è¡“äºˆå®šæ™‚åˆ»ã®24æ™‚é–“ä»¥ä¸Šå‰ã‹ã‚‰ä¼‘è–¬`, alert: true };
    if (period === "24æ™‚é–“å‰") return { text: `${fmt(sDate)} æ‰‹è¡“äºˆå®šæ™‚åˆ»ã®24æ™‚é–“å‰ã‹ã‚‰ä¼‘è–¬`, alert: true };
    if (period === "28æ—¥å‰") return { text: fmt(addDay(sDate, -28)), alert: true };
    if (period === "2é€±é–“") return { text: fmt(addDay(sDate, -14)), alert: true };
    if (period === "2æ—¥") return { text: fmt(addDay(sDate, -2)), alert: true };
    if (period === "2æ—¥å‰") return { text: fmt(addDay(sDate, -2)), alert: true };
    if (period === "3ã€œ7æ—¥") return { text: `${fmt(addDay(sDate, -7))}ï½${fmt(addDay(sDate, -3))}`, alert: true };
    if (period === "3æ—¥å‰") return { text: fmt(addDay(sDate, -3)), alert: true };
    if (period === "4ï½6é€±é–“") return { text: `${fmt(addDay(sDate, -42))}ï½${fmt(addDay(sDate, -28))}`, alert: true };
    if (period === "48æ™‚é–“å‰") return { text: `${fmt(sDate)} æ‰‹è¡“äºˆå®šæ™‚åˆ»ã®48æ™‚é–“å‰ã‹ã‚‰ä¼‘è–¬`, alert: true };
    if (period === "5æ—¥ä»¥ä¸Šå‰") return { text: `${fmt(addDay(sDate, -5))}ã‚ˆã‚Šå‰ã‹ã‚‰ä¼‘è–¬`, alert: true };
    if (period === "7ï½10 æ—¥å‰") return { text: `${fmt(addDay(sDate, -10))}ï½${fmt(addDay(sDate, -7))}`, alert: true };
    if (period === "7æ—¥å‰") return { text: fmt(addDay(sDate, -7)), alert: true };
    if (period === "è³‡æ–™å‚ç…§") return { text: "è¦ç¢ºèª", alert: true };
    if (period === "å‰å¾Œ2æ—¥") return { text: `${fmt(addDay(sDate, -2))}ï½${fmt(addDay(sDate, 2))}`, alert: true };
    if (period === "å½“æ—¥") return { text: fmt(sDate), alert: true };
    if (period === "ç³–å°¿ç—…3æ—¥å‰/å¿ƒä¸å…¨å½“æ—¥") return { text: `${fmt(addDay(sDate, -3))} ã¾ãŸã¯ ${fmt(sDate)}`, alert: true };
    if (period === "æ‰‹è¡“å‰ï¼”é€±ï½¤è¡“å¾Œï¼’é€±") return { text: `${fmt(addDay(sDate, -28))}ï½${fmt(addDay(sDate, 14))}`, alert: true };
    
    if (["ï½µï¾‹ï¾Ÿï½µï½²ï¾„ï¾æŠ•ä¸1é€±é–“å‰", "ç¶™ç¶šã‚’æ¨å¥¨", "æ­¯ç§‘æ‰‹è¡“ï¼’ã‚«æœˆå‰", "ä¸»æ²»åŒ»åˆ¤æ–­", "é™¢å†…æ¨å¥¨æœŸé–“ãªã—"].includes(period)) { return { text: "-", alert: false }; }
    return { text: "-", alert: false };
}

function calcScheduleTab() {
    const dStr = document.getElementById("scheduleDateInput").value;
    const area = document.getElementById("scheduleResultArea");
    const dateText = dStr ? new Date(dStr).toLocaleDateString('ja-JP', {year:'numeric', month:'2-digit', day:'2-digit'}) : "æœªè¨­å®š";
    document.getElementById("printScheduleDateDisplay").textContent = "æ‰‹è¡“äºˆå®šæ—¥ï¼š" + dateText;
    if (!dStr) { area.innerHTML = ""; return; }
    
    const schedulePatterns = ["1ï½3æ—¥", "1æ—¥å‰", "1é€±é–“", "24 æ™‚é–“ä»¥ä¸Š", "24æ™‚é–“å‰", "28æ—¥å‰", "2é€±é–“", "2æ—¥", "2æ—¥å‰", "3ã€œ7æ—¥", "3æ—¥å‰", "4ï½6é€±é–“", "48æ™‚é–“å‰", "5æ—¥ä»¥ä¸Šå‰", "7ï½10 æ—¥å‰", "7æ—¥å‰", "ï½µï¾‹ï¾Ÿï½µï½²ï¾„ï¾æŠ•ä¸1é€±é–“å‰", "è³‡æ–™å‚ç…§", "ç¶™ç¶šã‚’æ¨å¥¨", "æ­¯ç§‘æ‰‹è¡“ï¼’ã‚«æœˆå‰", "ä¸»æ²»åŒ»åˆ¤æ–­", "å‰å¾Œ2æ—¥", "é•·æœŸä¸å‹•çŠ¶æ…‹ã®ï¼“æ—¥å‰", "å½“æ—¥", "ç³–å°¿ç—…3æ—¥å‰/å¿ƒä¸å…¨å½“æ—¥", "é™¢å†…æ¨å¥¨æœŸé–“ãªã—", "æ‰‹è¡“å‰ï¼”é€±ï½¤è¡“å¾Œï¼’é€±"];
    let html = `<table class="table table-bordered mt-3 w-auto table-custom"><thead><tr style="background-color:#2c3e50; color:white;"><th>ä¼‘è–¬è¦å®š</th><th>è¨ˆç®—çµæœ</th></tr></thead><tbody>`;
    schedulePatterns.forEach(pat => {
        const res = calculateStopDateStrict(pat, dStr);
        html += `<tr><td>${pat}</td><td>${res.text}</td></tr>`;
    });
    html += `</tbody></table>`;
    area.innerHTML = html;
}

function filterMasterTable() {
    const txt = document.getElementById("masterSearch").value;
    const tbody = document.getElementById("masterTableBody");
    tbody.innerHTML = "";
    const keywords = txt.replace(/ã€€/g, " ").trim().split(" ").filter(k => k !== "");
    masterData.forEach(row => {
        let isMatch = true;
        if (keywords.length > 0) {
            const rowStr = (row.brandName + " " + row.genericName + " " + row.type).toLowerCase();
            isMatch = keywords.some(kw => rowStr.includes(kw.toLowerCase()));
        }
        if (isMatch) {
            const tr = document.createElement("tr");
            tr.innerHTML = `<td class="cell-nowrap">${row.type}</td><td class="fw-bold text-primary cell-nowrap">${row.brandName}</td><td class="cell-wrap">${row.genericName}</td><td>${row.period}</td><td class="small">${row.reason}</td>`;
            tbody.appendChild(tr);
        }
    });
}

// æŠ—å‡å›ºãƒ—ãƒ­ãƒˆã‚³ãƒ«
let currentDrug = null;
let currentSurgery = null;
const definitions = {
    warfarin: {
        high: "<div class='risk-list'><div class='hanging-item'>ãƒ»å¿ƒåŸæ€§è„³å¡æ “ç—‡ã®æ—¢å¾€</div><div class='hanging-item'>ãƒ»å¼è†œç—‡ã‚’åˆä½µã™ã‚‹å¿ƒæˆ¿ç´°å‹•</div><div class='hanging-item'>ãƒ»å¼è†œç—‡ã§ã¯ãªã„ãŒè„³å’ä¸­ã®é«˜ãƒªã‚¹ã‚¯å¿ƒæˆ¿ç´°å‹•</div><div class='hanging-item'>ãƒ»æ©Ÿæ¢°å¼ç½®æ›è¡“å¾Œã®è¡€æ “å¡æ “ç—‡ã®æ—¢å¾€</div><div class='hanging-item'>ãƒ»åƒ§å¸½å¼ã®æ©Ÿæ¢°å¼ç½®æ›è¡“å¾Œ</div><div class='hanging-item'>ãƒ»æŠ—ãƒªãƒ³è„‚è³ªæŠ—ä½“ç—‡å€™ç¾¤</div><div class='hanging-item'>ãƒ»æ·±éƒ¨é™è„ˆè¡€æ “ç—‡ãƒ»è‚ºå¡æ “ç—‡</div></div>",
        low: "å·¦è¨˜ä»¥å¤–"
    },
    doac: { high: "ãƒ¯ãƒ¼ãƒ•ã‚¡ãƒªãƒ³ã«æº–ãšã‚‹", low: "ãƒ¯ãƒ¼ãƒ•ã‚¡ãƒªãƒ³ã«æº–ãšã‚‹" },
    platelet: {
        high: "<div class='risk-list'><div class='hanging-item'>ãƒ»å† å‹•è„ˆã‚¹ãƒ†ãƒ³ãƒˆç•™ç½®å¾Œ2ãƒ¶æœˆä»¥å†…</div><div class='hanging-item'>ãƒ»å† å‹•è„ˆè–¬å‰¤æº¶å‡ºæ€§ã‚¹ãƒ†ãƒ³ãƒˆç•™ç½®å¾Œ12ãƒ¶æœˆä»¥å†…</div><div class='hanging-item'>ãƒ»è„³è¡€è¡Œå†å»ºè¡“å¾Œ2ãƒ¶æœˆä»¥å†…</div><div class='hanging-item'>ãƒ»ä¸»å¹¹å‹•è„ˆã«50%ä»¥ä¸Šã®ç‹­çª„ã‚’ä¼´ã†è„³æ¢—å¡åˆã¯ä¸€éæ€§è„³è™šè¡€ç™ºä½œ</div><div class='hanging-item'>ãƒ»æœ€è¿‘ç™ºç—‡ã—ãŸè™šè¡€æ€§è„³å’ä¸­åˆã¯ä¸€éæ€§è„³è™šè¡€ç™ºä½œ</div><div class='hanging-item'>ãƒ»é–‰å¡æ€§å‹•è„ˆç¡¬åŒ–ç—‡ã§Fontaine3åº¦(å®‰é™æ™‚ç–¼ç—›)ä»¥ä¸Š</div><div class='hanging-item'>ãƒ»é ¸å‹•è„ˆã‚¨ã‚³ãƒ¼åˆã¯é ­é ¸éƒ¨MRIã§ã€ä¼‘è–¬ã¯å±é™ºãŒé«˜ã„ã¨ã•ã‚Œã‚‹æ‰€è¦‹ã‚’æœ‰ã™ã‚‹</div></div>",
        low: "å·¦è¨˜ä»¥å¤–"
    }
};
const footerTexts = {
    warfarin: "<strong>ãƒ˜ãƒ‘ãƒªãƒ³ç½®æ›ã‚’è¡Œã£ãŸå ´åˆã®ãƒ˜ãƒ‘ãƒªãƒ³ä¸­æ­¢æ™‚æœŸï¼š</strong><br>ãƒ¯ãƒ¼ãƒ•ã‚¡ãƒªãƒ³å†é–‹1ã€œ2æ—¥å¾Œã«ä¸­æ­¢ï¼ˆä¸­æ­¢æ™‚åŠ¹æœç¢ºèªï¼‰ã€‚<br>ï¼ˆãƒ¯ãƒ¼ãƒ•ã‚¡ãƒªãƒ³å†é–‹5æ—¥ç›®ä»¥é™ã€è‡³é©INRå›å¾©ã®ç¢ºèªã‚’è¡Œã†ï¼‰",
    doac: "<strong>ãƒ˜ãƒ‘ãƒªãƒ³ç½®æ›ã‚’è¡Œã£ãŸå ´åˆã®ãƒ˜ãƒ‘ãƒªãƒ³ä¸­æ­¢æ™‚æœŸï¼š</strong><br>æŒç¶šé™æ³¨æ™‚ï¼ˆæœªåˆ†ç”»ãƒ˜ãƒ‘ãƒªãƒ³ï¼‰ï¼šDOACæŠ•ä¸é–‹å§‹æ™‚ã«ä¸­æ­¢ã€‚<br>çš®ä¸‹æ³¨æ™‚ï¼ˆã‚¯ãƒ¬ã‚­ã‚µãƒ³ç­‰ï¼‰ï¼š<br>ãƒ»ãƒ—ãƒ©ã‚¶ã‚­ã‚µã¯æ¬¡å›çš®ä¸‹æ³¨è£½å‰¤æŠ•ä¸2æ™‚é–“å‰ã«æŠ•ä¸é–‹å§‹ã€æ¬¡å›çš®ä¸‹æ³¨è£½å‰¤ã®æŠ•ä¸ä¸­æ­¢ã€‚<br>ãƒ»ã‚¤ã‚°ã‚¶ãƒ¬ãƒ«ãƒˆã¯æ¬¡å›çš®ä¸‹æ³¨è£½å‰¤æŠ•ä¸0ã€œ2æ™‚é–“å‰ã«æŠ•ä¸é–‹å§‹ã€‚<br>ãƒ»ã‚¨ãƒªã‚­ãƒ¥ãƒ¼ã‚¹/ãƒªã‚¯ã‚·ã‚¢ãƒŠã¯æ¬¡å›çš®ä¸‹æ³¨è£½å‰¤æŠ•ä¸æ™‚é–“ã«æŠ•ä¸é–‹å§‹ã€‚",
    platelet: "<strong>ãƒ˜ãƒ‘ãƒªãƒ³ç½®æ›ã‚’è¡Œã£ãŸå ´åˆã®ãƒ˜ãƒ‘ãƒªãƒ³ä¸­æ­¢æ™‚æœŸï¼š</strong><br>æŠ—è¡€å°æ¿å‰¤å†é–‹3ã€œ4æ—¥å¾Œã«ä¸­æ­¢"
};
function setACDrug(drug, btn) {
    currentDrug = drug;
    document.querySelectorAll('#drug-buttons button').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
    updateACDisplay();
}
function setACSurgery(surgery, btn) {
    currentSurgery = surgery;
    document.querySelectorAll('#surgery-buttons button').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
    updateACDisplay();
}
function getAcScheduleHtml(daysOff, sDateVal) {
    if(!sDateVal || daysOff === 0) return "";
    const sDate = new Date(sDateVal);
    const fmt = d => (d.getMonth() + 1) + '/' + d.getDate();
    let minDays, maxDays;
    if (Array.isArray(daysOff)) { minDays = daysOff[0]; maxDays = daysOff[1]; } 
    else { minDays = daysOff; maxDays = daysOff; }
    if (minDays === maxDays) {
        const d = new Date(sDate); d.setDate(sDate.getDate() - minDays);
        return `${fmt(d)}ã‹ã‚‰ä¼‘è–¬`;
    } else {
        const d1 = new Date(sDate); d1.setDate(sDate.getDate() - maxDays);
        const d2 = new Date(sDate); d2.setDate(sDate.getDate() - minDays);
        return `${fmt(d1)}ï½${fmt(d2)}ã‹ã‚‰ä¼‘è–¬`;
    }
}
function updateACDisplay() {
    if(!currentDrug || !currentSurgery) return;
    const resArea = document.getElementById('ac-result-area');
    resArea.style.display = 'block';
    
    let defKey = currentDrug.startsWith('doac') ? 'doac' : (currentDrug.startsWith('platelet') ? 'platelet' : 'warfarin');
    document.getElementById('high-risk-def').innerHTML = definitions[defKey].high;
    document.getElementById('low-risk-def').innerHTML = definitions[defKey].low;
    document.getElementById('footer-text').innerHTML = footerTexts[defKey];
    document.getElementById('footer-note').style.display = 'block';

    let h_msg = "", l_msg = "";
    let h_days = 0, l_days = 0;

    if(currentDrug === 'warfarin') {
        if(currentSurgery === 'dental') { h_msg = l_msg = "ç¶™ç¶šä¸‹ã§ã®æ–½è¡Œæ¨å¥¨<br><span style='font-size:0.9rem'>ï¼ˆæ²»ç™‚åŸŸå†…ç¢ºèªï¼‰</span>"; }
        else if(currentSurgery === 'minor') { h_msg = l_msg = "ä¼‘è–¬ãªã—<br><span style='font-size:0.9rem'>ï¼ˆæ²»ç™‚åŸŸå†…ç¢ºèªï¼‰</span>"; }
        else if(currentSurgery === 'major') { h_msg = "ã€ä¼‘è–¬æœŸé–“ã€‘3ã€œ5æ—¥<br><div class='bridge-info'>ä¸­æ­¢ç¿Œæ—¥ã‚ˆã‚Šãƒ˜ãƒ‘ãƒªãƒ³ç½®æ›</div>"; l_msg = "ã€ä¼‘è–¬æœŸé–“ã€‘3ã€œ5æ—¥"; h_days = [3,5]; l_days = [3,5]; }
        else if(currentSurgery === 'spinal') { h_msg = "ã€ä¼‘è–¬æœŸé–“ã€‘5æ—¥<br><div class='bridge-info'>ä¸­æ­¢ç¿Œæ—¥ã‚ˆã‚Šãƒ˜ãƒ‘ãƒªãƒ³ç½®æ›</div><div style='font-size:0.8rem;margin-top:5px'>â€»ç©¿åˆºæ‰‹æŠ€å‰ã«PT-INR<1.2ã‚’ç¢ºèª</div>"; l_msg = "ç©¿åˆºæ‰‹æŠ€å‰ã«ã€PT-INR<1.2ã‚’ç¢ºèªã™ã‚‹<br><span style='font-size:0.8rem'>ï¼ˆä½ãƒªã‚¹ã‚¯ç¾¤ã§ã¯ä¼‘è–¬ãªã—ï¼‰</span>"; h_days = 5; }
    } else if(currentDrug === 'doac_pe') {
        if(currentSurgery === 'dental') { h_msg = l_msg = "ç¶™ç¶šä¸‹ã§ã®æ–½è¡Œæ¨å¥¨"; }
        else if(currentSurgery === 'minor') { h_msg = "ã€ä¼‘è–¬æœŸé–“ã€‘1æ—¥<br><div class='bridge-info'>ãƒ—ãƒ©ã‚¶ã‚­ã‚µï¼šç¶™ç¶šä¸‹ã§æ–½è¡Œã™ã‚‹ãŒã€trough aPTT>80ç§’ã®å ´åˆã¯ã€ç·Šæ€¥æ€§ã®ãªã„æ‰‹è¡“ã¯é¿ã‘ã‚‹</div>"; l_msg = "ã€ä¼‘è–¬æœŸé–“ã€‘1æ—¥<br><span style='font-size:0.8rem'>ãƒ¯ãƒ¼ãƒ•ã‚¡ãƒªãƒ³ã«æº–ãšã‚‹</span>"; h_days = l_days = 1; }
        else if(currentSurgery === 'major') { h_msg = "ã€ä¼‘è–¬æœŸé–“ã€‘2æ—¥<br><div class='bridge-info'>ãƒ—ãƒ©ã‚¶ã‚­ã‚µãƒ»ã‚¨ãƒªã‚­ãƒ¥ãƒ¼ã‚¹ï¼šæœ€çµ‚æŠ•ä¸12æ™‚é–“å¾Œã‚ˆã‚Šãƒ˜ãƒ‘ãƒªãƒ³ç½®æ›</div>"; l_msg = "ã€ä¼‘è–¬æœŸé–“ã€‘2æ—¥"; h_days = l_days = 2; }
        else if(currentSurgery === 'spinal') { h_msg = "ã€ä¼‘è–¬æœŸé–“ã€‘<br>ãƒ—ãƒ©ã‚¶ã‚­ã‚µ 4æ—¥(CrClâ‰§60)ã€œ5æ—¥(30<CrCl<60)<br>ã‚¨ãƒªã‚­ãƒ¥ãƒ¼ã‚¹ 3æ—¥<br><div class='bridge-info'>ãƒ—ãƒ©ã‚¶ã‚­ã‚µãƒ»ã‚¨ãƒªã‚­ãƒ¥ãƒ¼ã‚¹ï¼šæœ€çµ‚æŠ•ä¸12æ™‚é–“å¾Œã‚ˆã‚Šãƒ˜ãƒ‘ãƒªãƒ³ç½®æ›</div>"; l_msg = "ä½ãƒªã‚¹ã‚¯ç¾¤ã§ã¯å‡ºè¡€æ™‚ã«åœ§è¿«ã«ã‚ˆã‚‹æ­¢è¡€å¯¾å¿œãŒå¯èƒ½ã§ã‚ã‚‹ã“ã¨ã‹ã‚‰ã€ä»®ã«ä¼‘è–¬ã™ã‚‹å ´åˆã«ã¯ä¼‘è–¬æœŸé–“ã‚’åŠæ¸›æœŸã®2å€ç¨‹åº¦ã«ç•™ã‚ã‚‹ã“ã¨ãŒåˆç†çš„ã§ã‚ã‚‹"; h_days = [3,5]; }
    } else if(currentDrug === 'doac_il') {
        if(currentSurgery === 'dental') { h_msg = l_msg = "ç¶™ç¶šä¸‹ã§ã®æ–½è¡Œæ¨å¥¨"; }
        else if(currentSurgery === 'minor') { h_msg = l_msg = "ã€ä¼‘è–¬æœŸé–“ã€‘1æ—¥"; h_days = l_days = 1; }
        else if(currentSurgery === 'major') { h_msg = "ã€ä¼‘è–¬æœŸé–“ã€‘1æ—¥<br><div class='bridge-info'>ã‚¤ã‚°ã‚¶ãƒ¬ãƒ«ãƒˆãƒ»ãƒªã‚¯ã‚·ã‚¢ãƒŠï¼šæœ€çµ‚æŠ•ä¸24æ™‚é–“å¾Œã‚ˆã‚Šãƒ˜ãƒ‘ãƒªãƒ³ç½®æ›</div>"; l_msg = "ã€ä¼‘è–¬æœŸé–“ã€‘1æ—¥"; h_days = l_days = 1; }
        else if(currentSurgery === 'spinal') { h_msg = "ã€ä¼‘è–¬æœŸé–“ã€‘2æ—¥<br><div class='bridge-info'>ã‚¤ã‚°ã‚¶ãƒ¬ãƒ«ãƒˆãƒ»ãƒªã‚¯ã‚·ã‚¢ãƒŠï¼šæœ€çµ‚æŠ•ä¸24æ™‚é–“å¾Œã‚ˆã‚Šãƒ˜ãƒ‘ãƒªãƒ³ç½®æ›</div>"; l_msg = "ä½ãƒªã‚¹ã‚¯ç¾¤ã§ã¯å‡ºè¡€æ™‚ã«åœ§è¿«ã«ã‚ˆã‚‹æ­¢è¡€å¯¾å¿œãŒå¯èƒ½ã§ã‚ã‚‹ã“ã¨ã‹ã‚‰ã€ä»®ã«ä¼‘è–¬ã™ã‚‹å ´åˆã«ã¯ä¼‘è–¬æœŸé–“ã‚’åŠæ¸›æœŸã®2å€ç¨‹åº¦ã«ç•™ã‚ã‚‹ã“ã¨ãŒåˆç†çš„ã§ã‚ã‚‹"; h_days = 2; }
    } else if(currentDrug === 'platelet_main') {
        if(currentSurgery === 'dental') { h_msg = l_msg = "ç¶™ç¶šä¸‹ã§ã®æ–½è¡Œã‚’åŸå‰‡ã¨ã™ã‚‹"; }
        else if(currentSurgery === 'minor') { h_msg = l_msg = "ç¶™ç¶šä¸‹ã§ã®æ–½è¡Œã‚’åŸå‰‡ã¨ã™ã‚‹"; }
        else if(currentSurgery === 'major') { h_msg = "ã€ä¼‘è–¬æœŸé–“ã€‘7æ—¥<br><span style='font-size:0.9rem'>(ãƒã‚¤ã‚¢ã‚¹ãƒ”ãƒªãƒ³ãƒ»ãƒ‘ãƒŠãƒ«ã‚¸ãƒ³ãƒ»ã‚¯ãƒ­ãƒ”ãƒ‰ã‚°ãƒ¬ãƒ«ãƒ»ã‚¨ãƒ•ã‚£ã‚¨ãƒ³ãƒˆ)</span><br><div class='bridge-info'>ä¸­æ­¢ç¿Œæ—¥ã‚ˆã‚Šãƒ˜ãƒ‘ãƒªãƒ³ç½®æ›</div>"; l_msg = "ã€ä¼‘è–¬æœŸé–“ã€‘7æ—¥<br><div class='bridge-info'>å ´åˆã«ã‚ˆã£ã¦ã€ä¸­æ­¢ç¿Œæ—¥ã‚ˆã‚Šãƒ˜ãƒ‘ãƒªãƒ³ç½®æ›</div>"; h_days = l_days = 7; }
        else if(currentSurgery === 'spinal') { h_msg = "ã€ä¼‘è–¬æœŸé–“ã€‘7æ—¥<br><div class='bridge-info'>ï¼ˆå¿…è¦ã«å¿œã˜ã¦ã€ï¼‰ä¸­æ­¢ç¿Œæ—¥ã‚ˆã‚Šãƒ˜ãƒ‘ãƒªãƒ³ç½®æ›</div>"; l_msg = "ä½ãƒªã‚¹ã‚¯ç¾¤ã§ã¯ä¼‘è–¬ãªã—"; h_days = 7; }
    } else if(currentDrug === 'platelet_cilo') {
        if(currentSurgery === 'dental') { h_msg = l_msg = "ç¶™ç¶šä¸‹ã§ã®æ–½è¡Œã‚’åŸå‰‡ã¨ã™ã‚‹"; }
        else if(currentSurgery === 'minor') { h_msg = l_msg = "ç¶™ç¶šä¸‹ã§ã®æ–½è¡Œã‚’åŸå‰‡ã¨ã™ã‚‹"; }
        else if(currentSurgery === 'major') { h_msg = "ã€ä¼‘è–¬æœŸé–“ã€‘ã‚·ãƒ­ã‚¹ã‚¿ã‚¾ãƒ¼ãƒ« 2æ—¥<br><div class='bridge-info'>ä¸­æ­¢ç¿Œæ—¥ã‚ˆã‚Šãƒ˜ãƒ‘ãƒªãƒ³ç½®æ›</div>"; l_msg = "ã€ä¼‘è–¬æœŸé–“ã€‘2æ—¥<br><div class='bridge-info'>å ´åˆã«ã‚ˆã£ã¦ã€ä¸­æ­¢ç¿Œæ—¥ã‚ˆã‚Šãƒ˜ãƒ‘ãƒªãƒ³ç½®æ›</div>"; h_days = l_days = 2; }
        else if(currentSurgery === 'spinal') { h_msg = "ã€ä¼‘è–¬æœŸé–“ã€‘ã‚·ãƒ­ã‚¹ã‚¿ã‚¾ãƒ¼ãƒ« 2æ—¥<br><div class='bridge-info'>ï¼ˆå¿…è¦ã«å¿œã˜ã¦ã€ï¼‰ä¸­æ­¢ç¿Œæ—¥ã‚ˆã‚Šãƒ˜ãƒ‘ãƒªãƒ³ç½®æ›</div>"; l_msg = "ä½ãƒªã‚¹ã‚¯ç¾¤ã§ã¯ä¼‘è–¬ãªã—"; h_days = 2; }
    }
    document.getElementById('high-risk-action').innerHTML = h_msg;
    document.getElementById('low-risk-action').innerHTML = l_msg;
    const sDateVal = document.getElementById('ac-surgery-date').value;
    const highSch = document.getElementById('high-schedule');
    const lowSch = document.getElementById('low-schedule');
    if(sDateVal) {
        highSch.style.display = 'block'; lowSch.style.display = 'block';
        highSch.innerHTML = getAcScheduleHtml(h_days, sDateVal);
        lowSch.innerHTML = getAcScheduleHtml(l_days, sDateVal);
    } else {
        highSch.style.display = 'none'; lowSch.style.display = 'none';
    }
    resArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

window.onload = init;
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
